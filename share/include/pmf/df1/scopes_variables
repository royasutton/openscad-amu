#!/usr/bin/make -f
################################################################################
#
#  Copyright (C) 2016 Roy Allen Sutton
#
#  This file is part of OpenSCAD AutoMake Utilities ([openscad-amu]
#  (https://github.com/royasutton/openscad-amu)).
#
#  openscad-amu is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  openscad-amu is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  [GNU General Public License] (https://www.gnu.org/licenses/gpl.html)
#  for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with openscad-amu.  If not, see <http://www.gnu.org/licenses/>.
#
################################################################################

################################################################################
# Variables
################################################################################

# auxiliary script output path prefix
scopes_prefix := $(if $(call bool_decode,$(prefix_scopes_scripts)),$(output_directory))

# openscad_seam_opts1: for modes=(extract|list)
openscad_seam_opts1 := \
  $(strip \
    --joiner $(scopes_joiner) \
    --makefile-ext $(mf_ext) \
    --mfscript-ext $(mfs_ext) \
    --openscad-ext $(scad_ext) \
  )

# openscad_seam_opts1: for modes=(extract)
openscad_seam_opts2 := \
  $(strip \
    --prefix $(output_directory) \
    --prefix-ipp 0 \
    --prefix-scripts $(if $(call bool_decode,$(prefix_scopes_scripts)),yes,no) \
    --comments yes \
    --show $(if $(call bool_decode,$(verbose_seam_show)),yes,no) \
    --run no \
    --make no \
    $(if $(AMU_LIB_PATH),--lib-path $(AMU_LIB_PATH)) \
    --openscad-path $(path_openscad) \
    --bash-path $(path_bash) \
    --make-path $(path_gnumake) \
    --write-config yes \
    $(if $(call bool_decode,$(debug_seam_scanner)),--debug) \
    $(if $(call bool_decode,$(verbose_seam)),--verbose) \
  )

# scopes auxiliary scripts for all source files
scopes_scripts := \
  $(addprefix $(scopes_prefix), \
    $(foreach s,$(src_files), \
      $(shell $(path_openscad_seam) --mode list --input $s $(openscad_seam_opts1)) \
    ) \
  )

# scopes include filter
ifndef scopes_include_filter
  scopes_include_filter := $(strip $(foreach s, $(scopes_include), \
    %$(scopes_joiner)$(s)$(scad_ext) %$(scopes_joiner)$(s)$(mfs_ext)))
else
  $(call amu_pm_m,using pre-defined value for $$(scopes_include_filter))
endif

ifdef scopes_include_filter
  $(call amu_pm_m,applying scopes include filter [$(scopes_include_filter)])
  scopes_scripts := $(filter $(scopes_include_filter),$(scopes_scripts))
else
  $(call amu_pm_m,no scopes include filtering)
endif

# scopes exclude filter
ifndef scopes_exclude_filter
  scopes_exclude_filter := $(strip $(foreach s, $(scopes_exclude), \
    %$(scopes_joiner)$(s)$(scad_ext) %$(scopes_joiner)$(s)$(mfs_ext)))
else
  $(call amu_pm_m,using pre-defined value for $$(scopes_exclude_filter))
endif

ifdef scopes_exclude_filter
  $(call amu_pm_m,applying scopes exclude filter [$(scopes_exclude_filter)])
  scopes_scripts := $(filter-out $(scopes_exclude_filter),$(scopes_scripts))
else
  $(call amu_pm_m,no scopes exclude filtering)
endif

# assign modeling scripts to clean-files
scopes_clean_files := $(filter %$(scad_ext),$(scopes_scripts))

#------------------------------------------------------------------------------#
# Configuration Variable List
#------------------------------------------------------------------------------#

scopes_config_variables := \
  scopes_joiner \
  \
  scopes_include \
  scopes_exclude

scopes_config_derived += \
  scopes_prefix \
  \
  scopes_include_filter \
  scopes_exclude_filter \
  \
  openscad_seam_opts1 \
  openscad_seam_opts2

#------------------------------------------------------------------------------#
# Version Checks
#------------------------------------------------------------------------------#
ifeq ($(version_checks),$(true))

# openscad-seam v1.5 or later required to auto-extract scope names
$(call check_version,amuseam,ge,1.5,$(true), \
$(newline)# \
$(newline)#$(space3)openscad-seam '--mode scopes' option required to auto-extract scope \
$(newline)#$(space3)names. Option introduced in version v1.5. \
$(newline)#)

endif

#------------------------------------------------------------------------------#
# Help text
#------------------------------------------------------------------------------#

define help_text_scopes
 all-scopes:
     build all openscad-amu scope components.

 clean-scopes:
     clean all openscad-amu scope components.

 install-scopes:
     nothing.

 uninstall-scopes:
     nothing.

 info-scopes:
     scope components information.
endef

################################################################################
# eof
################################################################################
